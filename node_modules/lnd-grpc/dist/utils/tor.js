"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = tor;
var _child_process = _interopRequireDefault(require("child_process"));
var _fs = _interopRequireDefault(require("fs"));
var _os = _interopRequireDefault(require("os"));
var _path = _interopRequireDefault(require("path"));
var _debug = _interopRequireDefault(require("debug"));
var _getPort = _interopRequireDefault(require("get-port"));
var _delay = _interopRequireDefault(require("./delay"));
var _constants = require("./constants");
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
const debug = (0, _debug.default)('lnrpc:tor');
const debugTor = (0, _debug.default)('lnrpc:torproc');
function tor({
  cwd
} = {}) {
  let proc = null;
  const isStarted = () => Boolean(proc && proc.pid);

  /**
   * start - Start Tor tunnel service.
   * @param  {object}  settings Settings
   * @param  {string}  settings.datadir Data dir
   *
   * @return {Promise} Promise that resolves once the service is ready to use
   */
  const start = async () => {
    if (isStarted()) {
      throw new Error('Tor is already already running');
    }
    const datadir = cwd || _fs.default.mkdtempSync(_path.default.join(_os.default.tmpdir(), 'lnd-grpc-'));
    const torrcpath = _path.default.join(datadir, 'torrc');
    const datapath = _path.default.join(datadir, 'data');
    const host = '127.0.0.1';
    const port = await (0, _getPort.default)({
      host,
      port: _getPort.default.makeRange(9065, 9999)
    });
    const httpTunnelPort = `${host}:${port}`;
    const settings = {
      DataDirectory: datapath,
      HTTPTunnelPort: httpTunnelPort,
      SocksPort: 0
    };
    debug('Starting tor with settings: %o', settings);
    const torrc = Object.entries(settings).reduce((acc, [key, value]) => {
      return acc += `${key} ${value}\n`;
    }, '');
    _fs.default.writeFileSync(torrcpath, torrc);
    debug('Generated torrc at %s:\n%s', torrcpath, torrc);
    process.env.grpc_proxy = `http://${httpTunnelPort}`;
    debug('Setting grpc_proxy as: %s', process.env.grpc_proxy);
    proc = _child_process.default.spawn('tor', ['-f', torrcpath], {
      cwd: datadir
    });
    debug('Started tor process with pid: %s', proc.pid);
    process.on('exit', () => {
      proc.kill();
    });
    process.on('uncaughtException', () => {
      proc.kill();
    });
    return new Promise((resolve, reject) => {
      proc.stdout.on('data', async data => {
        debugTor(data.toString().trim());
        if (data.toString().indexOf('Bootstrapped 100%') !== -1) {
          await (0, _delay.default)(_constants.TOR_WAIT_TIMEOUT);
          resolve(true);
        }
        if (data.toString().indexOf('[error]') !== -1) {
          reject(data.toString());
        }
      });
    });
  };

  /**
   * Stop Tor service.
   */
  const stop = async () => {
    if (isStarted()) {
      debug('Stopping tor with pid: %o', proc.pid);
      const waitForExit = new Promise((resolve, reject) => {
        proc.on('exit', () => {
          debug('Stopped tor with pid: %o', proc.pid);
          delete process.env.grpc_proxy;
          resolve();
        });
      });
      proc.kill('SIGKILL');
      return waitForExit;
    }
  };
  return {
    start,
    stop,
    isStarted
  };
}
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJkZWJ1ZyIsImNyZWF0ZURlYnVnIiwiZGVidWdUb3IiLCJ0b3IiLCJjd2QiLCJwcm9jIiwiaXNTdGFydGVkIiwiQm9vbGVhbiIsInBpZCIsInN0YXJ0IiwiRXJyb3IiLCJkYXRhZGlyIiwiZnMiLCJta2R0ZW1wU3luYyIsInBhdGgiLCJqb2luIiwib3MiLCJ0bXBkaXIiLCJ0b3JyY3BhdGgiLCJkYXRhcGF0aCIsImhvc3QiLCJwb3J0IiwiZ2V0UG9ydCIsIm1ha2VSYW5nZSIsImh0dHBUdW5uZWxQb3J0Iiwic2V0dGluZ3MiLCJEYXRhRGlyZWN0b3J5IiwiSFRUUFR1bm5lbFBvcnQiLCJTb2Nrc1BvcnQiLCJ0b3JyYyIsIk9iamVjdCIsImVudHJpZXMiLCJyZWR1Y2UiLCJhY2MiLCJrZXkiLCJ2YWx1ZSIsIndyaXRlRmlsZVN5bmMiLCJwcm9jZXNzIiwiZW52IiwiZ3JwY19wcm94eSIsImNoaWxkIiwic3Bhd24iLCJvbiIsImtpbGwiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsInN0ZG91dCIsImRhdGEiLCJ0b1N0cmluZyIsInRyaW0iLCJpbmRleE9mIiwiZGVsYXkiLCJUT1JfV0FJVF9USU1FT1VUIiwic3RvcCIsIndhaXRGb3JFeGl0Il0sInNvdXJjZXMiOlsiLi4vLi4vc3JjL3V0aWxzL3Rvci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY2hpbGQgZnJvbSAnY2hpbGRfcHJvY2VzcydcbmltcG9ydCBmcyBmcm9tICdmcydcbmltcG9ydCBvcyBmcm9tICdvcydcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnXG5pbXBvcnQgY3JlYXRlRGVidWcgZnJvbSAnZGVidWcnXG5pbXBvcnQgZ2V0UG9ydCBmcm9tICdnZXQtcG9ydCdcbmltcG9ydCBkZWxheSBmcm9tICcuL2RlbGF5J1xuaW1wb3J0IHsgVE9SX1dBSVRfVElNRU9VVCB9IGZyb20gJy4vY29uc3RhbnRzJ1xuXG5jb25zdCBkZWJ1ZyA9IGNyZWF0ZURlYnVnKCdsbnJwYzp0b3InKVxuY29uc3QgZGVidWdUb3IgPSBjcmVhdGVEZWJ1ZygnbG5ycGM6dG9ycHJvYycpXG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIHRvcih7IGN3ZCB9ID0ge30pIHtcbiAgbGV0IHByb2MgPSBudWxsXG5cbiAgY29uc3QgaXNTdGFydGVkID0gKCkgPT4gQm9vbGVhbihwcm9jICYmIHByb2MucGlkKVxuXG4gIC8qKlxuICAgKiBzdGFydCAtIFN0YXJ0IFRvciB0dW5uZWwgc2VydmljZS5cbiAgICogQHBhcmFtICB7b2JqZWN0fSAgc2V0dGluZ3MgU2V0dGluZ3NcbiAgICogQHBhcmFtICB7c3RyaW5nfSAgc2V0dGluZ3MuZGF0YWRpciBEYXRhIGRpclxuICAgKlxuICAgKiBAcmV0dXJuIHtQcm9taXNlfSBQcm9taXNlIHRoYXQgcmVzb2x2ZXMgb25jZSB0aGUgc2VydmljZSBpcyByZWFkeSB0byB1c2VcbiAgICovXG4gIGNvbnN0IHN0YXJ0ID0gYXN5bmMgKCkgPT4ge1xuICAgIGlmIChpc1N0YXJ0ZWQoKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdUb3IgaXMgYWxyZWFkeSBhbHJlYWR5IHJ1bm5pbmcnKVxuICAgIH1cblxuICAgIGNvbnN0IGRhdGFkaXIgPSBjd2QgfHwgZnMubWtkdGVtcFN5bmMocGF0aC5qb2luKG9zLnRtcGRpcigpLCAnbG5kLWdycGMtJykpXG4gICAgY29uc3QgdG9ycmNwYXRoID0gcGF0aC5qb2luKGRhdGFkaXIsICd0b3JyYycpXG4gICAgY29uc3QgZGF0YXBhdGggPSBwYXRoLmpvaW4oZGF0YWRpciwgJ2RhdGEnKVxuICAgIGNvbnN0IGhvc3QgPSAnMTI3LjAuMC4xJ1xuICAgIGNvbnN0IHBvcnQgPSBhd2FpdCBnZXRQb3J0KHsgaG9zdCwgcG9ydDogZ2V0UG9ydC5tYWtlUmFuZ2UoOTA2NSwgOTk5OSkgfSlcbiAgICBjb25zdCBodHRwVHVubmVsUG9ydCA9IGAke2hvc3R9OiR7cG9ydH1gXG5cbiAgICBjb25zdCBzZXR0aW5ncyA9IHtcbiAgICAgIERhdGFEaXJlY3Rvcnk6IGRhdGFwYXRoLFxuICAgICAgSFRUUFR1bm5lbFBvcnQ6IGh0dHBUdW5uZWxQb3J0LFxuICAgICAgU29ja3NQb3J0OiAwLFxuICAgIH1cblxuICAgIGRlYnVnKCdTdGFydGluZyB0b3Igd2l0aCBzZXR0aW5nczogJW8nLCBzZXR0aW5ncylcblxuICAgIGNvbnN0IHRvcnJjID0gT2JqZWN0LmVudHJpZXMoc2V0dGluZ3MpLnJlZHVjZSgoYWNjLCBba2V5LCB2YWx1ZV0pID0+IHtcbiAgICAgIHJldHVybiAoYWNjICs9IGAke2tleX0gJHt2YWx1ZX1cXG5gKVxuICAgIH0sICcnKVxuICAgIGZzLndyaXRlRmlsZVN5bmModG9ycmNwYXRoLCB0b3JyYylcbiAgICBkZWJ1ZygnR2VuZXJhdGVkIHRvcnJjIGF0ICVzOlxcbiVzJywgdG9ycmNwYXRoLCB0b3JyYylcblxuICAgIHByb2Nlc3MuZW52LmdycGNfcHJveHkgPSBgaHR0cDovLyR7aHR0cFR1bm5lbFBvcnR9YFxuICAgIGRlYnVnKCdTZXR0aW5nIGdycGNfcHJveHkgYXM6ICVzJywgcHJvY2Vzcy5lbnYuZ3JwY19wcm94eSlcblxuICAgIHByb2MgPSBjaGlsZC5zcGF3bigndG9yJywgWyctZicsIHRvcnJjcGF0aF0sIHsgY3dkOiBkYXRhZGlyIH0pXG4gICAgZGVidWcoJ1N0YXJ0ZWQgdG9yIHByb2Nlc3Mgd2l0aCBwaWQ6ICVzJywgcHJvYy5waWQpXG5cbiAgICBwcm9jZXNzLm9uKCdleGl0JywgKCkgPT4ge1xuICAgICAgcHJvYy5raWxsKClcbiAgICB9KVxuICAgIHByb2Nlc3Mub24oJ3VuY2F1Z2h0RXhjZXB0aW9uJywgKCkgPT4ge1xuICAgICAgcHJvYy5raWxsKClcbiAgICB9KVxuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHByb2Muc3Rkb3V0Lm9uKCdkYXRhJywgYXN5bmMgKGRhdGEpID0+IHtcbiAgICAgICAgZGVidWdUb3IoZGF0YS50b1N0cmluZygpLnRyaW0oKSlcbiAgICAgICAgaWYgKGRhdGEudG9TdHJpbmcoKS5pbmRleE9mKCdCb290c3RyYXBwZWQgMTAwJScpICE9PSAtMSkge1xuICAgICAgICAgIGF3YWl0IGRlbGF5KFRPUl9XQUlUX1RJTUVPVVQpXG4gICAgICAgICAgcmVzb2x2ZSh0cnVlKVxuICAgICAgICB9XG4gICAgICAgIGlmIChkYXRhLnRvU3RyaW5nKCkuaW5kZXhPZignW2Vycm9yXScpICE9PSAtMSkge1xuICAgICAgICAgIHJlamVjdChkYXRhLnRvU3RyaW5nKCkpXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfSlcbiAgfVxuXG4gIC8qKlxuICAgKiBTdG9wIFRvciBzZXJ2aWNlLlxuICAgKi9cbiAgY29uc3Qgc3RvcCA9IGFzeW5jICgpID0+IHtcbiAgICBpZiAoaXNTdGFydGVkKCkpIHtcbiAgICAgIGRlYnVnKCdTdG9wcGluZyB0b3Igd2l0aCBwaWQ6ICVvJywgcHJvYy5waWQpXG5cbiAgICAgIGNvbnN0IHdhaXRGb3JFeGl0ID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICBwcm9jLm9uKCdleGl0JywgKCkgPT4ge1xuICAgICAgICAgIGRlYnVnKCdTdG9wcGVkIHRvciB3aXRoIHBpZDogJW8nLCBwcm9jLnBpZClcbiAgICAgICAgICBkZWxldGUgcHJvY2Vzcy5lbnYuZ3JwY19wcm94eVxuICAgICAgICAgIHJlc29sdmUoKVxuICAgICAgICB9KVxuICAgICAgfSlcblxuICAgICAgcHJvYy5raWxsKCdTSUdLSUxMJylcbiAgICAgIHJldHVybiB3YWl0Rm9yRXhpdFxuICAgIH1cbiAgfVxuXG4gIHJldHVybiB7XG4gICAgc3RhcnQsXG4gICAgc3RvcCxcbiAgICBpc1N0YXJ0ZWQsXG4gIH1cbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUE4QztBQUU5QyxNQUFNQSxLQUFLLEdBQUcsSUFBQUMsY0FBVyxFQUFDLFdBQVcsQ0FBQztBQUN0QyxN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